<!DOCTYPE html>
<html>
<head>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
</head>
<body>
<div>
  <h2 class="text-center">Reset Your Password</h2>
</div>

<form id="resetPasswordForm" style="max-width: 350px; margin: 0 auto;">
  <input type="hidden" name="token" th:value="${token}"/>
  <div class="border border-secondary rounded p-3">
    <div class="mb-3">
      <input type="password" name="password" id="password" class="form-control"
             placeholder="Enter your new password" required autofocus/>
    </div>
    <div class="mb-3">
      <input type="password" name="confirmPassword" id="confirmPassword" class="form-control" placeholder="Confirm your new password"
             required oninput="checkPasswordMatch(this);"/>
      <div class="invalid-feedback">Passwords do not match!</div>
    </div>
    <div class="text-center">
      <button type="button" class="btn btn-primary" onclick="submitForm()">Change Password</button>
    </div>
  </div>
</form>

<script>
  function checkPasswordMatch(fieldConfirmPassword) {
    const password = document.getElementById("password").value;
    if (fieldConfirmPassword.value !== password) {
      fieldConfirmPassword.setCustomValidity("Passwords do not match!");
      fieldConfirmPassword.classList.add("is-invalid");
    } else {
      fieldConfirmPassword.setCustomValidity("");
      fieldConfirmPassword.classList.remove("is-invalid");
    }
  }

  // Function to submit the form using fetch API and send JSON
  function submitForm() {
    const token = document.querySelector("input[name='token']").value;
    const password = document.querySelector("input[name='password']").value;
    const confirmPassword = document.querySelector("input[name='confirmPassword']").value;

    if (password !== confirmPassword) {
      alert("Passwords do not match!");
      return;
    }

    fetch("/whm/api/v1/auth/reset_password", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        token: token,
        password: password
      })
    })
    .then(response => {
      if (response.ok) {
        alert("Password successfully reset");
      } else {
        return response.text().then(text => { throw new Error(text); });
      }
    })
    .catch(error => {
      alert("Error: " + error.message);
    });
  }
</script>

</body>
</html>
